<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/css/admin.css" />
    <title>CRUD Catálogo - Prueba</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: middle; }
        th { background-color: #f0f0f0; }
        input, select, button { margin: 5px 0; padding: 5px; }
        form { margin-top: 20px; }
        img.producto-img { width: 50px; height: 50px; object-fit: cover; }
    </style>
</head>
<body>
    <h1>CRUD Catálogo</h1>

    <!-- Tabla de productos -->
    <table id="tablaProductos">
        <thead>
            <tr>
                <th>ID</th>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Unidad</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Formulario -->
    <form id="formProducto">
        <h2 id="tituloForm">Crear Producto</h2>
        <input type="hidden" id="idProducto">
        <div>
            <label>Nombre:</label>
            <input type="text" id="nombreProducto" required>
        </div>
        <div>
            <label>ID Categoría:</label>
            <input type="number" id="idCategoria" required>
        </div>
        <div>
            <label>Descripción:</label>
            <input type="text" id="descripcion">
        </div>
        <div>
            <label>Unidad:</label>
            <input type="text" id="unidadMedida" value="unidad">
        </div>
        <div>
            <label>Precio:</label>
            <input type="number" id="precio" step="0.01" required>
        </div>
        <div>
            <label>Estado:</label>
            <select id="estado">
                <option value="1">Activo</option>
                <option value="0">Inactivo</option>
            </select>
        </div>
        <div>
            <label>Stock Inicial:</label>
            <input type="number" id="stock" step="1" required>
        </div>
        <div>
            <label>URL Imagen:</label>
            <input type="text" id="imagen">
        </div>
        <button type="submit">Guardar</button>
        <button type="button" onclick="resetForm()">Cancelar</button>
    </form>

    <script>
    const apiUrl = "http://localhost:5026/api/Catalogo"; // Usando CatalogoController

    // Cargar productos
    async function cargarProductos() {
        try {
            const res = await fetch(apiUrl);
            const data = await res.json();
            const tbody = document.querySelector("#tablaProductos tbody");
            tbody.innerHTML = "";
            data.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.idProducto}</td>
                        <td><img src="${p.imagen || ''}" class="producto-img" alt="Imagen"></td>
                        <td>${p.nombreProducto}</td>
                        <td>${p.categoria?.nombreCategoria || ''}</td>
                        <td>${p.descripcion}</td>
                        <td>${p.precio.toFixed(2)}</td>
                        <td>${p.unidadMedida}</td>
                        <td>${p.estado == 1 ? 'Activo' : 'Inactivo'}</td>
                        <td>
                            <button onclick="editarProducto(${p.idProducto})">Editar</button>
                            <button onclick="eliminarProducto(${p.idProducto})">Eliminar</button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error("Error cargando productos:", error);
        }
    }

    // Crear o actualizar producto
    document.getElementById("formProducto").addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("idProducto").value;
        const producto = {
            IdProducto: id || 0,
            NombreProducto: document.getElementById("nombreProducto").value,
            IdCategoria: parseInt(document.getElementById("idCategoria").value),
            Descripcion: document.getElementById("descripcion").value,
            UnidadMedida: document.getElementById("unidadMedida").value,
            Precio: parseFloat(document.getElementById("precio").value),
            Estado: parseInt(document.getElementById("estado").value),
            Stock: parseInt(document.getElementById("stock").value),
            Imagen: document.getElementById("imagen").value
        };

        try {
            if(id) {
                // PUT para actualizar
                await fetch(`${apiUrl}/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(producto)
                });
            } else {
                // POST para crear
                await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(producto)
                });
            }
            resetForm();
            cargarProductos();
        } catch (error) {
            console.error("Error guardando producto:", error);
        }
    });

    // Editar producto
    async function editarProducto(id) {
        try {
            const res = await fetch(`${apiUrl}/${id}`);
            const p = await res.json();
            document.getElementById("tituloForm").textContent = "Editar Producto";
            document.getElementById("idProducto").value = p.idProducto;
            document.getElementById("nombreProducto").value = p.nombreProducto;
            document.getElementById("idCategoria").value = p.idCategoria;
            document.getElementById("descripcion").value = p.descripcion;
            document.getElementById("unidadMedida").value = p.unidadMedida;
            document.getElementById("precio").value = p.precio;
            document.getElementById("estado").value = p.estado;
            document.getElementById("stock").value = p.stock || 0;
            document.getElementById("imagen").value = p.imagen || '';
        } catch (error) {
            console.error("Error cargando producto:", error);
        }
    }

    // Eliminar producto
    async function eliminarProducto(id) {
        if(confirm("¿Deseas eliminar este producto?")) {
            try {
                await fetch(`${apiUrl}/${id}`, { method: "DELETE" });
                cargarProductos();
            } catch (error) {
                console.error("Error eliminando producto:", error);
            }
        }
    }

    // Reset formulario
    function resetForm() {
        document.getElementById("formProducto").reset();
        document.getElementById("idProducto").value = "";
        document.getElementById("tituloForm").textContent = "Crear Producto";
    }

    // Inicializar tabla al cargar la página
    cargarProductos();
</script>



</body>
</html>